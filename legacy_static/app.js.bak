/**
 * è‡ªåŠ¨åŒ–ä»»åŠ¡ç®¡ç† Web UI - å‰ç«¯åº”ç”¨
 */

// ==================== å…¨å±€çŠ¶æ€ ====================
let tasks = [];
let outputs = [];
let currentTask = null;
let statusPollingInterval = null;
let selectedCompany = "ä¸­ç§»ç³»ç»Ÿé›†æˆæœ‰é™å…¬å¸"; // é»˜è®¤å…¬å¸åç§°

// ==================== åˆå§‹åŒ– ====================
document.addEventListener('DOMContentLoaded', () => {
    initNavigation();
    loadCompanySelector();
    loadTasks();
});

async function loadCompanySelector() {
    try {
        const response = await fetch('/api/company-names');
        const data = await response.json();
        
        if (data.success) {
            const select = document.getElementById('company-select');
            if (select) {
                select.innerHTML = data.companies.map(name => 
                    `<option value="${name}" ${name === 'ä¸­ç§»ç³»ç»Ÿé›†æˆæœ‰é™å…¬å¸' ? 'selected' : ''}>${name}</option>`
                ).join('');
            }
        }
    } catch (error) {
        console.error('åŠ è½½å…¬å¸åˆ—è¡¨å¤±è´¥', error);
    }
}

// ==================== å¯¼èˆª ====================
function initNavigation() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const view = item.dataset.view;
            switchView(view);
        });
    });
}

function switchView(viewName) {
    // æ›´æ–°å¯¼èˆªçŠ¶æ€
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.view === viewName);
    });
    
    // åˆ‡æ¢è§†å›¾
    document.querySelectorAll('.view').forEach(view => {
        view.classList.toggle('active', view.id === `${viewName}-view`);
    });
    
    // åŠ è½½å¯¹åº”æ•°æ®
    if (viewName === 'tasks') {
        loadTasks();
    } else if (viewName === 'batches') {
        loadBatches();
    } else if (viewName === 'companies') {
        loadCompanies();
    } else if (viewName === 'compare') {
        loadCompareView();
    } else if (viewName === 'config') {
        loadConfig();
    }
    
    // å…³é—­è¯¦æƒ…æ‚¬æµ®æ¡†
    closeTaskDetail();
}

// ==================== ä»»åŠ¡ç®¡ç† ====================
async function loadTasks() {
    const container = document.getElementById('tasks-container');
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    try {
        const response = await fetch('/api/tasks');
        const data = await response.json();
        
        if (data.success) {
            tasks = data.tasks;
            renderTasks();
        } else {
            showToast('åŠ è½½ä»»åŠ¡å¤±è´¥: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
    }
}

function renderTasks() {
    const container = document.getElementById('tasks-container');
    
    if (tasks.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ“‹</div>
                <div class="empty-title">æš‚æ— ä»»åŠ¡</div>
                <div class="empty-text">ç‚¹å‡»"æ–°å»ºä»»åŠ¡"åˆ›å»ºç¬¬ä¸€ä¸ªè‡ªåŠ¨åŒ–ä»»åŠ¡</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="tasks-table-container">
            <table class="tasks-table">
                <thead>
                    <tr>
                        <th>ä»»åŠ¡åç§°</th>
                        <th>æè¿°</th>
                        <th>ç›®æ ‡ç½‘å€</th>
                        <th>åŠ¨ä½œæ•°</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${tasks.map(task => `
                        <tr onclick="showTaskDetail('${task._file}', event)">
                            <td class="task-name-cell">${task.name || task._file}</td>
                            <td class="task-description-cell" title="${task.description || 'æš‚æ— æè¿°'}">${task.description || 'æš‚æ— æè¿°'}</td>
                            <td class="task-url-cell" title="${task.url || 'N/A'}">${truncateUrl(task.url)}</td>
                            <td class="task-actions-cell">${task.actions?.length || 0}</td>
                            <td>
                                <span class="task-status idle" id="status-${task._file}">å°±ç»ª</span>
                            </td>
                            <td>
                                <div class="task-actions-buttons" onclick="event.stopPropagation()">
                                    <button class="btn btn-success btn-sm" onclick="runTask('${task._file}')" title="è¿è¡Œä»»åŠ¡">
                                        â–¶
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="editTask('${task._file}')" title="ç¼–è¾‘ä»»åŠ¡">
                                        âœï¸
                                    </button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteTask('${task._file}')" title="åˆ é™¤ä»»åŠ¡">
                                        ğŸ—‘ï¸
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function truncateUrl(url) {
    if (!url) return 'N/A';
    try {
        const urlObj = new URL(url);
        return urlObj.hostname;
    } catch {
        return url.substring(0, 30) + '...';
    }
}

// ==================== ä»»åŠ¡è¯¦æƒ… ====================
let detailPopover = null;
let detailPopoverTimeout = null;

async function showTaskDetail(filename, event) {
    // å¦‚æœç‚¹å‡»çš„æ˜¯æŒ‰é’®ï¼Œä¸æ˜¾ç¤ºè¯¦æƒ…
    if (event && (event.target.tagName === 'BUTTON' || event.target.closest('button'))) {
        return;
    }
    
    // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
    if (detailPopoverTimeout) {
        clearTimeout(detailPopoverTimeout);
    }
    
    // åˆ›å»ºæˆ–è·å–æ‚¬æµ®æ¡†
    if (!detailPopover) {
        detailPopover = document.createElement('div');
        detailPopover.className = 'detail-popover';
        detailPopover.innerHTML = `
            <div class="popover-header">
                <h2 id="popover-title">ä»»åŠ¡è¯¦æƒ…</h2>
                <button class="btn-close" onclick="closeTaskDetail()">Ã—</button>
            </div>
            <div class="popover-content" id="popover-content"></div>
        `;
        document.body.appendChild(detailPopover);
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        document.addEventListener('click', (e) => {
            if (detailPopover && !detailPopover.contains(e.target) && !e.target.closest('tr[onclick*="showTaskDetail"]')) {
                closeTaskDetail();
            }
        });
    }
    
    const content = document.getElementById('popover-content');
    const title = document.getElementById('popover-title');
    
    // è·å–ç‚¹å‡»ä½ç½®
    const rect = event ? event.currentTarget.getBoundingClientRect() : { top: 100, left: 100, bottom: 150, right: 200 };
    
    // è®¡ç®—ä½ç½®ï¼Œç¡®ä¿ä¸è¶…å‡ºå±å¹•
    const popoverWidth = 500;
    const popoverHeight = 600;
    const margin = 10;
    
    let top = rect.bottom + margin;
    let left = rect.left;
    
    // å¦‚æœä¸‹æ–¹ç©ºé—´ä¸è¶³ï¼Œæ˜¾ç¤ºåœ¨ä¸Šæ–¹
    if (top + popoverHeight > window.innerHeight) {
        top = rect.top - popoverHeight - margin;
        if (top < 0) top = margin; // å¦‚æœä¸Šæ–¹ä¹Ÿä¸å¤Ÿï¼Œè´´é¡¶éƒ¨
    }
    
    // å¦‚æœå³ä¾§ç©ºé—´ä¸è¶³ï¼Œè°ƒæ•´åˆ°å·¦ä¾§
    if (left + popoverWidth > window.innerWidth) {
        left = window.innerWidth - popoverWidth - margin;
    }
    if (left < margin) left = margin;
    
    // è®¾ç½®ä½ç½®
    detailPopover.style.top = top + 'px';
    detailPopover.style.left = left + 'px';
    detailPopover.style.transform = 'none';
    
    content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    detailPopover.classList.add('show');
    
    try {
        const response = await fetch(`/api/tasks/${filename}`);
        const data = await response.json();
        
        if (data.success) {
            currentTask = data.task;
            title.textContent = currentTask.name || filename;
            
            content.innerHTML = `
                <div class="form-group">
                    <label class="form-label">ä»»åŠ¡åç§°</label>
                    <div class="form-input" style="background: var(--bg-secondary); padding: 8px 12px;">${currentTask.name || 'N/A'}</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æè¿°</label>
                    <div class="form-input" style="background: var(--bg-secondary); padding: 8px 12px;">${currentTask.description || 'æš‚æ— æè¿°'}</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ç›®æ ‡ç½‘å€</label>
                    <div class="form-input" style="background: var(--bg-secondary); padding: 8px 12px; word-break: break-all;">
                        <a href="${currentTask.url}" target="_blank" style="color: var(--accent-blue)">${currentTask.url || 'N/A'}</a>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">åŠ¨ä½œåˆ—è¡¨ (${currentTask.actions?.length || 0})</label>
                    <div class="actions-list">
                        ${(currentTask.actions || []).map((action, idx) => `
                            <div class="action-item">
                                <span style="color: var(--text-muted)">${idx + 1}</span>
                                <span class="action-type">${action.type}</span>
                                <span class="action-detail">${getActionDetail(action)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">è¾“å‡ºæ–‡ä»¶</label>
                    <div class="form-input" style="background: var(--bg-secondary); padding: 8px 12px;">${currentTask.output_file || 'N/A'}</div>
                </div>
                
                <div class="form-group" id="log-section" style="display: none;">
                    <label class="form-label">æ‰§è¡Œæ—¥å¿—</label>
                    <div class="log-container" id="task-logs"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ‰§è¡Œå…¬å¸</label>
                    <select class="form-select" id="popover-company-select" style="width: 100%;">
                        <option value="ä¸­ç§»ç³»ç»Ÿé›†æˆæœ‰é™å…¬å¸" ${selectedCompany === 'ä¸­ç§»ç³»ç»Ÿé›†æˆæœ‰é™å…¬å¸' ? 'selected' : ''}>ä¸­ç§»ç³»ç»Ÿé›†æˆæœ‰é™å…¬å¸</option>
                        <option value="è”é€šæ•°å­—ç§‘æŠ€æœ‰é™å…¬å¸" ${selectedCompany === 'è”é€šæ•°å­—ç§‘æŠ€æœ‰é™å…¬å¸' ? 'selected' : ''}>è”é€šæ•°å­—ç§‘æŠ€æœ‰é™å…¬å¸</option>
                        <option value="ä¸­ç”µä¿¡æ•°æ™ºç§‘æŠ€æœ‰é™å…¬å¸" ${selectedCompany === 'ä¸­ç”µä¿¡æ•°æ™ºç§‘æŠ€æœ‰é™å…¬å¸' ? 'selected' : ''}>ä¸­ç”µä¿¡æ•°æ™ºç§‘æŠ€æœ‰é™å…¬å¸</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 12px; margin-top: 20px;">
                    <button class="btn btn-success" onclick="runTaskFromPopover('${filename}')">
                        â–¶ è¿è¡Œä»»åŠ¡
                    </button>
                    <button class="btn btn-secondary" onclick="editTask('${filename}')">
                        âœï¸ ç¼–è¾‘é…ç½®
                    </button>
                </div>
            `;
            
            // æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
            checkTaskStatus(filename);
        }
    } catch (error) {
        content.innerHTML = '<div class="empty-state"><div class="empty-title">åŠ è½½å¤±è´¥</div></div>';
        showToast('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥', 'error');
    }
}

function closeTaskDetail() {
    if (detailPopover) {
        detailPopover.classList.remove('show');
    }
    if (detailPopoverTimeout) {
        clearTimeout(detailPopoverTimeout);
    }
}

function toggleCertificateCard(detailsId) {
    const detailsElement = document.getElementById(detailsId);
    const iconElement = document.getElementById(`icon-${detailsId}`);
    
    if (!detailsElement || !iconElement) return;
    
    if (detailsElement.style.display === 'none') {
        detailsElement.style.display = 'block';
        iconElement.textContent = 'â–¼';
        iconElement.style.transform = 'rotate(0deg)';
    } else {
        detailsElement.style.display = 'none';
        iconElement.textContent = 'â–¶';
        iconElement.style.transform = 'rotate(-90deg)';
    }
}

function runTaskFromPopover(filename) {
    const companySelect = document.getElementById('popover-company-select');
    if (companySelect) {
        selectedCompany = companySelect.value;
        // åŒæ­¥æ›´æ–°ä¸»ç•Œé¢çš„é€‰æ‹©å™¨
        const mainSelect = document.getElementById('company-select');
        if (mainSelect) {
            mainSelect.value = selectedCompany;
        }
    }
    runTask(filename);
    closeTaskDetail();
}

function getActionDetail(action) {
    switch (action.type) {
        case 'input':
            return `${action.target} â†’ "${action.value}"`;
        case 'click':
            return action.target;
        case 'wait':
            return `${action.seconds}ç§’`;
        case 'screenshot':
            return action.filename;
        case 'screenshot_ocr':
            return `æˆªå›¾OCR: ${action.filename || 'screenshot_ocr.png'}`;
        case 'extract':
            return action.target;
        case 'extract_text':
        case 'extract_all_text':
            return 'æå–é¡µé¢æ‰€æœ‰æ–‡å­—';
        case 'checkbox':
            return `${action.target} = ${action.checked}`;
        case 'select':
            return `${action.target} â†’ ${action.value}`;
        case 'submit':
            return action.target || 'æäº¤è¡¨å•';
        case 'click_and_navigate':
            return action.target;
        case 'switch_to_new_window':
            return 'åˆ‡æ¢åˆ°æ–°çª—å£';
        case 'switch_to_latest_tab':
            return 'åˆ‡æ¢åˆ°æœ€æ–°æ ‡ç­¾é¡µ';
        case 'loop_click_extract':
            return `å¾ªç¯æå–: ${action.list_selector || ''}`;
        case 'find_links_extract':
            return `æŸ¥æ‰¾é“¾æ¥: ${action.match_text || ''}`;
        default:
            return JSON.stringify(action);
    }
}

function closeDetailPanel() {
    closeTaskDetail();
    currentTask = null;
    if (statusPollingInterval) {
        clearInterval(statusPollingInterval);
        statusPollingInterval = null;
    }
}

// ==================== æ‰¹é‡ç®¡ç† ====================
let batches = [];
let batchPollingIntervals = {};

async function loadBatches() {
    const container = document.getElementById('batches-container');
    if (!container) return;
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

    try {
        const resp = await fetch('/api/batches');
        const data = await resp.json();
        if (data.success) {
            batches = data.batches || [];
            renderBatches();
        } else {
            container.innerHTML = '<div class="empty-state"><div class="empty-title">åŠ è½½å¤±è´¥</div></div>';
            showToast('åŠ è½½æ‰¹æ¬¡å¤±è´¥: ' + data.error, 'error');
        }
    } catch (e) {
        container.innerHTML = '<div class="empty-state"><div class="empty-title">ç½‘ç»œé”™è¯¯</div></div>';
        showToast('ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
    }
}

function renderBatches() {
    const container = document.getElementById('batches-container');
    if (!container) return;

    if (!batches || batches.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ”</div>
                <div class="empty-title">æš‚æ— æ‰¹æ¬¡</div>
                <div class="empty-text">ç‚¹å‡»"æ–°å»ºæ‰¹æ¬¡"åˆ›å»ºæ‰¹é‡è¿è¡Œ</div>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <div class="batches-table-container">
            <table class="tasks-table">
                <thead>
                    <tr>
                        <th>æ‰¹æ¬¡åç§°</th>
                        <th>ä»»åŠ¡æ•°</th>
                        <th>è¿›åº¦</th>
                        <th>çŠ¶æ€</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody>
                    ${batches.map(b => `
                        <tr>
                            <td>${b.name}</td>
                            <td>${b.progress?.total || (b.items && b.items.length) || 0}</td>
                            <td>${(b.progress?.completed||0)}/${(b.progress?.total||0)} å·²å®Œæˆï¼Œå¤±è´¥ ${(b.progress?.failed||0)}</td>
                            <td>${b.status || 'pending'}</td>
                            <td>
                                <div class="task-actions-buttons">
                                    <button class="btn btn-success btn-sm" onclick="startBatch('${b.id}')">â–¶ å¯åŠ¨</button>
                                    <button class="btn btn-secondary btn-sm" onclick="showBatchDetail('${b.id}')">è¯¦æƒ…</button>
                                    <button class="btn btn-warning btn-sm" onclick="showScheduleModal('${b.id}')">â° å®šæ—¶</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteBatch('${b.id}')">ğŸ—‘ï¸ åˆ é™¤</button>
                                </div>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function showCreateBatchModal() {
    const modal = document.getElementById('modal');
    const content = document.getElementById('modal-content');
    modal.classList.add('open');
    content.innerHTML = `
        <div class="modal-header"><h2>æ–°å»ºæ‰¹æ¬¡</h2><button class="btn-close" onclick="closeModal()">Ã—</button></div>
        <div class="modal-body">
            <div class="form-group">
                <label>æ‰¹æ¬¡åç§°</label>
                <input id="batch-name" class="form-input" />
            </div>
            <div class="form-group">
                <label>æ‰§è¡Œå…¬å¸</label>
                <select id="batch-company" class="form-select">
                    <option value="ä¸­ç§»ç³»ç»Ÿé›†æˆæœ‰é™å…¬å¸">ä¸­ç§»ç³»ç»Ÿé›†æˆæœ‰é™å…¬å¸</option>
                    <option value="è”é€šæ•°å­—ç§‘æŠ€æœ‰é™å…¬å¸">è”é€šæ•°å­—ç§‘æŠ€æœ‰é™å…¬å¸</option>
                    <option value="ä¸­ç”µä¿¡æ•°æ™ºç§‘æŠ€æœ‰é™å…¬å¸">ä¸­ç”µä¿¡æ•°æ™ºç§‘æŠ€æœ‰é™å…¬å¸</option>
                </select>
            </div>
            <div class="form-group">
                <label>é€‰æ‹©ä»»åŠ¡ï¼ˆå¯å¤šé€‰ï¼‰</label>
                <div id="batch-tasks-list" style="max-height:260px; overflow:auto; border:1px solid var(--border); padding:8px; background:var(--bg-secondary)"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="createBatch()">åˆ›å»ºå¹¶å¯åŠ¨</button>
            <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    `;

    // fill tasks
    const list = document.getElementById('batch-tasks-list');
    if (tasks && tasks.length) {
        list.innerHTML = tasks.map(t => `
            <label style="display:block; margin-bottom:6px;">
                <input type="checkbox" value="${t._file}" /> ${t.name || t._file}
            </label>
        `).join('');
    } else {
        list.innerHTML = '<div class="empty-text">æš‚æ— ä»»åŠ¡ï¼Œè¯·å…ˆåˆ›å»ºä»»åŠ¡</div>';
    }
}

async function createBatch() {
    const name = document.getElementById('batch-name').value || '';
    const company = document.getElementById('batch-company').value;
    const checkboxes = Array.from(document.querySelectorAll('#batch-tasks-list input[type="checkbox"]'));
    const selected = checkboxes.filter(c => c.checked).map(c => c.value);
    if (selected.length === 0) {
        showToast('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªä»»åŠ¡', 'error');
        return;
    }

    try {
        const resp = await fetch('/api/batches', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name, tasks: selected, company_name: company})
        });
        const data = await resp.json();
        if (data.success) {
            showToast('æ‰¹æ¬¡åˆ›å»ºæˆåŠŸ', 'success');
            closeModal();
            loadBatches();
            // auto start
            const id = data.batch.id;
            startBatch(id);
        } else {
            showToast('åˆ›å»ºå¤±è´¥: ' + data.error, 'error');
        }
    } catch (e) {
        showToast('ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
    }
}

async function startBatch(batchId) {
    try {
        const resp = await fetch(`/api/batches/${batchId}/start`, {method: 'POST'});
        const data = await resp.json();
        if (data.success) {
            showToast('æ‰¹æ¬¡å·²å¼€å§‹æ‰§è¡Œ', 'success');
            // start polling for this batch
            if (batchPollingIntervals[batchId]) clearInterval(batchPollingIntervals[batchId]);
            pollBatch(batchId);
            batchPollingIntervals[batchId] = setInterval(() => pollBatch(batchId), 3000);
            loadBatches();
        } else {
            showToast('å¯åŠ¨å¤±è´¥: ' + data.error, 'error');
        }
    } catch (e) {
        showToast('ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
    }
}

async function pollBatch(batchId) {
    try {
        const resp = await fetch(`/api/batches/${batchId}`);
        const data = await resp.json();
        if (data.success) {
            // update local batches
            const idx = batches.findIndex(b => b.id === batchId);
            if (idx >= 0) batches[idx] = data.batch;
            renderBatches();
            // update flow if detail open
            const detailEl = document.getElementById('batch-detail-' + batchId);
            if (detailEl && detailEl.dataset.open === '1') {
                // renderBatchFlow(batchId);  // flowchart removed
            }
            if (data.batch.status !== 'running' && batchPollingIntervals[batchId]) {
                clearInterval(batchPollingIntervals[batchId]);
                delete batchPollingIntervals[batchId];
            }
        }
    } catch (e) {
        // ignore
    }
}

async function showBatchDetail(batchId) {
    const modal = document.getElementById('modal');
    const content = document.getElementById('modal-content');
    modal.classList.add('open');
    content.innerHTML = '<div class="loading"><div class="spinner"></div></div>';

    try {
        const resp = await fetch(`/api/batches/${batchId}`);
        const data = await resp.json();
        if (!data.success) {
            content.innerHTML = '<div class="empty-title">åŠ è½½å¤±è´¥</div>';
            return;
        }

        const b = data.batch;
        content.innerHTML = `
            <div class="modal-header"><h2>æ‰¹æ¬¡è¯¦æƒ… - ${b.name}</h2><button class="btn-close" onclick="closeModal()">Ã—</button></div>
            <div class="modal-body">
                <div class="form-group"><label>çŠ¶æ€</label><div class="form-input">${b.status}</div></div>
                <div class="form-group"><label>è¿›åº¦</label><div class="form-input">${(b.progress.completed||0)}/${(b.progress.total||0)} å·²å®Œæˆï¼Œå¤±è´¥ ${(b.progress.failed||0)}</div></div>
                <div class="form-group"><label>ä»»åŠ¡åˆ—è¡¨</label>
                    <div style="max-height:180px; overflow:auto; padding:8px; background:var(--bg-secondary)">
                        ${(b.items||[]).map(it => `<div style="margin-bottom:6px;"><strong>[${it.index}]</strong> ${it.task._file || it.task.name || JSON.stringify(it.task)} â€” ${it.status}</div>`).join('')}
                    </div>
                </div>
                <div class="form-group"><label>æµç¨‹å›¾</label><div id="batch-flow-${b.id}" style="background:var(--bg-secondary); padding:12px; min-height:120px"></div></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="startBatch('${b.id}')">â–¶ é‡å¯</button>
                <button class="btn btn-secondary" onclick="closeModal()">å…³é—­</button>
            </div>
        `;

        // mark open
        const detailEl = document.getElementById('modal-content');
        detailEl.dataset.open = '1';

        // renderBatchFlow(b.id);  // flowchart removed
        // poll while open
        if (batchPollingIntervals[b.id]) clearInterval(batchPollingIntervals[b.id]);
        pollBatch(b.id);
        batchPollingIntervals[b.id] = setInterval(() => pollBatch(b.id), 3000);

    } catch (e) {
        content.innerHTML = '<div class="empty-title">ç½‘ç»œé”™è¯¯</div>';
    }
}

// flowchart rendering removed

async function showScheduleModal(batchId) {
    const modal = document.getElementById('modal');
    const content = document.getElementById('modal-content');
    modal.classList.add('open');
    content.innerHTML = `
        <div class="modal-header"><h2>å®šæ—¶ä»»åŠ¡</h2><button class="btn-close" onclick="closeModal()">Ã—</button></div>
        <div class="modal-body">
            <div class="form-group">
                <label>é—´éš”ï¼ˆç§’ï¼‰</label>
                <input id="schedule-interval" class="form-input" placeholder="ä¾‹å¦‚ 3600" />
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="scheduleBatch('${batchId}')">ä¿å­˜å¹¶å¯ç”¨</button>
            <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
        </div>
    `;
}

async function scheduleBatch(batchId) {
    const interval = parseInt(document.getElementById('schedule-interval').value || '0');
    if (!interval || interval <= 0) {
        showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é—´éš”ç§’æ•°', 'error');
        return;
    }

    try {
        const resp = await fetch(`/api/batches/${batchId}/schedule`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({interval_seconds: interval})
        });
        const data = await resp.json();
        if (data.success) {
            showToast('å®šæ—¶å·²å¯ç”¨', 'success');
            closeModal();
            loadBatches();
        } else {
            showToast('å®šæ—¶å¤±è´¥: ' + data.error, 'error');
        }
    } catch (e) {
        showToast('ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
    }
}

async function deleteBatch(batchId) {
    if (!confirm('ç¡®è®¤åˆ é™¤è¯¥æ‰¹æ¬¡å—ï¼Ÿ')) return;
    try {
        const resp = await fetch(`/api/batches/${batchId}`, {method: 'DELETE'});
        const data = await resp.json();
        if (data.success) {
            showToast('å·²åˆ é™¤', 'success');
            loadBatches();
        } else {
            showToast('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
        }
    } catch (e) {
        showToast('ç½‘ç»œé”™è¯¯: ' + e.message, 'error');
    }
}

// ==================== å…¬å¸é€‰æ‹© ====================
function updateCompanyName(companyName) {
    selectedCompany = companyName;
    showToast(`å·²é€‰æ‹©å…¬å¸: ${companyName}`, 'info');
}

// ==================== ä»»åŠ¡æ‰§è¡Œ ====================
async function runTask(filename) {
    try {
        // è·å–å½“å‰é€‰æ‹©çš„å…¬å¸åç§°
        const companySelect = document.getElementById('company-select');
        const companyName = companySelect ? companySelect.value : selectedCompany;
        
        const response = await fetch(`/api/tasks/${filename}/run`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ company_name: companyName })
        });
        const data = await response.json();
        
        if (data.success) {
            showToast(`ä»»åŠ¡å·²å¼€å§‹æ‰§è¡Œ (${companyName})`, 'success');
            
            // æ›´æ–°çŠ¶æ€
            const statusEl = document.getElementById(`status-${filename}`);
            if (statusEl) {
                statusEl.textContent = 'è¿è¡Œä¸­';
                statusEl.className = 'task-status running';
            }
            
            // æ˜¾ç¤ºæ—¥å¿—åŒºåŸŸ
            const logSection = document.getElementById('log-section');
            if (logSection) {
                logSection.style.display = 'block';
            }
            
            // å¼€å§‹è½®è¯¢çŠ¶æ€
            startStatusPolling(filename);
        } else {
            showToast(data.error || 'å¯åŠ¨å¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
    }
}

function startStatusPolling(filename) {
    if (statusPollingInterval) {
        clearInterval(statusPollingInterval);
    }
    
    statusPollingInterval = setInterval(async () => {
        await checkTaskStatus(filename);
    }, 1000);
}

async function checkTaskStatus(filename) {
    try {
        const response = await fetch(`/api/tasks/${filename}/status`);
        const data = await response.json();
        
        if (data.success) {
            // æ›´æ–°æ—¥å¿—
            const logsEl = document.getElementById('task-logs');
            if (logsEl && data.logs) {
                logsEl.innerHTML = data.logs.map(log => `
                    <div class="log-entry">${log}</div>
                `).join('');
                logsEl.scrollTop = logsEl.scrollHeight;
            }
            
            // æ›´æ–°çŠ¶æ€
            const statusEl = document.getElementById(`status-${filename}`);
            if (statusEl) {
                if (data.running) {
                    statusEl.textContent = 'è¿è¡Œä¸­';
                    statusEl.className = 'task-status running';
                } else if (data.error) {
                    statusEl.textContent = 'å¤±è´¥';
                    statusEl.className = 'task-status failed';
                } else if (data.result) {
                    statusEl.textContent = 'å®Œæˆ';
                    statusEl.className = 'task-status success';
                }
            }
            
            // ä»»åŠ¡å®Œæˆï¼Œåœæ­¢è½®è¯¢
            if (!data.running && statusPollingInterval) {
                clearInterval(statusPollingInterval);
                statusPollingInterval = null;
                
                if (data.result) {
                    showToast('ä»»åŠ¡æ‰§è¡Œå®Œæˆ', 'success');
                } else if (data.error) {
                    showToast('ä»»åŠ¡æ‰§è¡Œå¤±è´¥: ' + data.error, 'error');
                }
            }
        }
    } catch (error) {
        console.error('æ£€æŸ¥çŠ¶æ€å¤±è´¥:', error);
    }
}

// ==================== ä»»åŠ¡ç¼–è¾‘ ====================
async function editTask(filename) {
    try {
        const response = await fetch(`/api/tasks/${filename}`);
        const data = await response.json();
        
        if (data.success) {
            showEditModal(data.task, filename);
        }
    } catch (error) {
        showToast('åŠ è½½ä»»åŠ¡å¤±è´¥', 'error');
    }
}

function showEditModal(task, filename) {
    const modal = document.getElementById('modal');
    const content = document.getElementById('modal-content');
    
    content.innerHTML = `
        <div class="modal-header">
            <h3 class="modal-title">ç¼–è¾‘ä»»åŠ¡: ${filename}</h3>
            <button class="btn-close" onclick="closeModal()">Ã—</button>
        </div>
        
        <div class="task-editor">
            <div class="form-group">
                <label class="form-label">ä»»åŠ¡åç§°</label>
                <input class="form-input" id="edit-task-name" value="${escapeHtml(task.name || '')}" placeholder="ä»»åŠ¡åç§°">
            </div>
            
            <div class="form-group">
                <label class="form-label">ä»»åŠ¡æè¿°</label>
                <textarea class="form-textarea" id="edit-task-description" rows="2" placeholder="ä»»åŠ¡æè¿°">${escapeHtml(task.description || '')}</textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">ç›®æ ‡ç½‘å€</label>
                <input class="form-input" id="edit-task-url" value="${escapeHtml(task.url || '')}" placeholder="https://example.com">
            </div>
            
            <div class="form-group">
                <label class="form-label">è¾“å‡ºæ–‡ä»¶è·¯å¾„</label>
                <input class="form-input" id="edit-task-output" value="${escapeHtml(task.output_file || '')}" placeholder="output/result.csv">
            </div>
            
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <label class="form-label" style="margin: 0;">åŠ¨ä½œåˆ—è¡¨</label>
                    <button class="btn btn-primary btn-sm" onclick="addAction()">
                        <span>+</span> æ·»åŠ åŠ¨ä½œ
                    </button>
                </div>
                <div id="actions-container" class="actions-editor">
                    ${renderActionsEditor(task.actions || [])}
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveTask('${filename}')">ä¿å­˜</button>
        </div>
    `;
    
    modal.classList.add('open');
}

function renderActionsEditor(actions) {
    if (actions.length === 0) {
        return '<div class="empty-actions">æš‚æ— åŠ¨ä½œï¼Œç‚¹å‡»"æ·»åŠ åŠ¨ä½œ"å¼€å§‹é…ç½®</div>';
    }
    
    // é‡æ–°ç”Ÿæˆç´¢å¼•ï¼Œç¡®ä¿ä»0å¼€å§‹è¿ç»­
    return actions.map((action, index) => {
        // ä½¿ç”¨æ•°ç»„ç´¢å¼•ä½œä¸ºå”¯ä¸€æ ‡è¯†
        return renderActionItem(action, index, actions.length);
    }).join('');
}

function renderActionItem(action, index, totalActions) {
    const actionTypes = {
        'wait': 'ç­‰å¾…',
        'input': 'è¾“å…¥',
        'click': 'ç‚¹å‡»',
        'hover': 'æ‚¬åœ',
        'checkbox': 'å¤é€‰æ¡†',
        'select': 'é€‰æ‹©',
        'submit': 'æäº¤è¡¨å•',
        'extract': 'æå–',
        'extract_text': 'æå–é¡µé¢æ–‡å­—',
        'extract_all_text': 'æå–é¡µé¢æ–‡å­—',
        'find_links_extract': 'æŸ¥æ‰¾é“¾æ¥å¹¶æå–',
        'loop_click_extract': 'å¾ªç¯ç‚¹å‡»æå–',
        'geetest_captcha': 'éªŒè¯ç ',
        'screenshot': 'æˆªå›¾',
        'screenshot_ocr': 'æˆªå›¾OCRè¯†åˆ«',
        'navigate': 'å¯¼èˆª',
        'click_and_navigate': 'ç‚¹å‡»å¹¶å¯¼èˆª',
        'switch_to_new_window': 'åˆ‡æ¢åˆ°æ–°çª—å£',
        'switch_to_latest_tab': 'åˆ‡æ¢åˆ°æœ€æ–°æ ‡ç­¾é¡µ'
    };
    
    return `
        <div class="action-editor-item" data-index="${index}">
            <div class="action-editor-header">
                <div class="action-editor-number">${index + 1}</div>
                <div class="action-editor-type">${actionTypes[action.type] || action.type}</div>
                <div class="action-editor-actions">
                    <button class="btn-icon" onclick="moveAction(${index}, 'up')" ${index === 0 ? 'disabled' : ''} title="ä¸Šç§»">â†‘</button>
                    <button class="btn-icon" onclick="moveAction(${index}, 'down')" ${index === totalActions - 1 ? 'disabled' : ''} title="ä¸‹ç§»">â†“</button>
                    <button class="btn-icon" onclick="removeAction(${index})" title="åˆ é™¤">Ã—</button>
                </div>
            </div>
            <div class="action-editor-body">
                ${renderActionForm(action, index)}
            </div>
        </div>
    `;
}

function renderActionForm(action, index) {
    const type = action.type || 'wait';
    
    let formHtml = `
        <div class="form-group">
            <label class="form-label">åŠ¨ä½œç±»å‹</label>
            <select class="form-select" onchange="changeActionType(${index}, this.value)">
                <option value="wait" ${type === 'wait' ? 'selected' : ''}>ç­‰å¾…</option>
                <option value="input" ${type === 'input' ? 'selected' : ''}>è¾“å…¥</option>
                <option value="click" ${type === 'click' ? 'selected' : ''}>ç‚¹å‡»</option>
                <option value="hover" ${type === 'hover' ? 'selected' : ''}>æ‚¬åœ</option>
                <option value="checkbox" ${type === 'checkbox' ? 'selected' : ''}>å¤é€‰æ¡†</option>
                <option value="select" ${type === 'select' ? 'selected' : ''}>é€‰æ‹©</option>
                <option value="submit" ${type === 'submit' ? 'selected' : ''}>æäº¤è¡¨å•</option>
                <option value="extract" ${type === 'extract' ? 'selected' : ''}>æå–</option>
                <option value="extract_text" ${type === 'extract_text' ? 'selected' : ''}>æå–é¡µé¢æ–‡å­—</option>
                <option value="extract_all_text" ${type === 'extract_all_text' ? 'selected' : ''}>æå–é¡µé¢æ–‡å­—ï¼ˆåˆ«åï¼‰</option>
                <option value="find_links_extract" ${type === 'find_links_extract' ? 'selected' : ''}>æŸ¥æ‰¾é“¾æ¥å¹¶æå–</option>
                <option value="loop_click_extract" ${type === 'loop_click_extract' ? 'selected' : ''}>å¾ªç¯ç‚¹å‡»æå–</option>
                <option value="geetest_captcha" ${type === 'geetest_captcha' ? 'selected' : ''}>éªŒè¯ç </option>
                <option value="screenshot" ${type === 'screenshot' ? 'selected' : ''}>æˆªå›¾</option>
                <option value="screenshot_ocr" ${type === 'screenshot_ocr' ? 'selected' : ''}>æˆªå›¾OCRè¯†åˆ«</option>
                <option value="navigate" ${type === 'navigate' ? 'selected' : ''}>å¯¼èˆª</option>
                <option value="click_and_navigate" ${type === 'click_and_navigate' ? 'selected' : ''}>ç‚¹å‡»å¹¶å¯¼èˆª</option>
                <option value="switch_to_new_window" ${type === 'switch_to_new_window' ? 'selected' : ''}>åˆ‡æ¢åˆ°æ–°çª—å£</option>
                <option value="switch_to_latest_tab" ${type === 'switch_to_latest_tab' ? 'selected' : ''}>åˆ‡æ¢åˆ°æœ€æ–°æ ‡ç­¾é¡µ</option>
            </select>
        </div>
    `;
    
    // æ ¹æ®ç±»å‹æ¸²æŸ“ä¸åŒçš„è¡¨å•å­—æ®µ
    switch (type) {
        case 'wait':
            formHtml += `
                <div class="form-group">
                    <label class="form-label">ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰</label>
                    <input type="number" class="form-input" id="action-${index}-seconds" value="${action.seconds || 1}" min="0" step="0.1">
                </div>
            `;
            break;
            
        case 'input':
            formHtml += `
                <div class="form-group">
                    <label class="form-label">ç›®æ ‡é€‰æ‹©å™¨</label>
                    <input class="form-input" id="action-${index}-target" value="${escapeHtml(action.target || '')}" placeholder="input[placeholder*='æœç´¢']">
                </div>
                <div class="form-group">
                    <label class="form-label">è¾“å…¥å€¼</label>
                    <input class="form-input" id="action-${index}-value" value="${escapeHtml(action.value || '')}" placeholder="è¦è¾“å…¥çš„å†…å®¹">
                </div>
            `;
            break;
            
        case 'click':
        case 'hover':
            formHtml += `
                <div class="form-group">
                    <label class="form-label">ç›®æ ‡é€‰æ‹©å™¨</label>
                    <input class="form-input" id="action-${index}-target" value="${escapeHtml(action.target || '')}" placeholder="button.btn æˆ– text:æŒ‰é’®æ–‡å­—">
                </div>
            `;
            break;
            
        case 'checkbox':
            formHtml += `
                <div class="form-group">
                    <label class="form-label">ç›®æ ‡é€‰æ‹©å™¨</label>
                    <input class="form-input" id="action-${index}-target" value="${escapeHtml(action.target || '')}" placeholder="input[type='checkbox']">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="action-${index}-checked" ${action.checked ? 'checked' : ''}>
                        é€‰ä¸­çŠ¶æ€
                    </label>
                </div>
            `;
            break;
            
        case 'select':
            formHtml += `
                <div class="form-group">
                    <label class="form-label">ç›®æ ‡é€‰æ‹©å™¨</label>
                    <input class="form-input" id="action-${index}-target" value="${escapeHtml(action.target || '')}" placeholder="select[name='xxx']">
                </div>
                <div class="form-group">
                    <label class="form-label">é€‰é¡¹å€¼</label>
                    <input class="form-input" id="action-${index}-value" value="${escapeHtml(action.value || '')}" placeholder="è¦é€‰æ‹©çš„é€‰é¡¹å€¼">
                </div>
            `;
            break;
            
        case 'submit':
            formHtml += `
                <div class="form-group">
                    <label class="form-label">æäº¤æŒ‰é’®é€‰æ‹©å™¨ï¼ˆå¯é€‰ï¼‰</label>
                    <input class="form-input" id="action-${index}-target" value="${escapeHtml(action.target || '')}" placeholder="button[type='submit'] æˆ–ç•™ç©º">
                    <div class="form-hint">ç•™ç©ºåˆ™æäº¤å½“å‰è¡¨å•</div>
                </div>
            `;
            break;
            
        case 'extract':
            formHtml += `
                <div class="form-group">
                    <label class="form-label">ç›®æ ‡é€‰æ‹©å™¨</label>
                    <input class="form-input" id="action-${index}-target" value="${escapeHtml(action.target || '')}" placeholder="div.table æˆ– è¡¨æ ¼æ•°æ®">
                </div>
            `;
            break;
            
        case 'extract_text':
        case 'extract_all_text':
            formHtml += `
                <div class="form-group">
                    <div class="form-info">
                        <p>æ­¤åŠ¨ä½œå°†æå–å½“å‰é¡µé¢çš„æ‰€æœ‰å¯è§æ–‡å­—å†…å®¹ï¼Œæ— éœ€é¢å¤–å‚æ•°ã€‚</p>
                    </div>
                </div>
            `;
            break;
            
        case 'find_links_extract':
            formHtml += `
                <div class="form-group">
                    <label class="form-label">åŒ¹é…æ–‡å­—</label>
                    <input class="form-input" id="action-${index}-match_text" value="${escapeHtml(action.match_text || '')}" placeholder="è¦åŒ¹é…çš„é“¾æ¥æ–‡å­—">
                </div>
                <div class="form-group">
                    <label class="form-label">æå–é€‰æ‹©å™¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                    <textarea class="form-textarea" id="action-${index}-extract_selectors" rows="3" placeholder="div.content&#10;div.table">${(action.extract_selectors || []).join('\n')}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">è®¿é—®åç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰</label>
                    <input type="number" class="form-input" id="action-${index}-wait_after_visit" value="${action.wait_after_visit || 2}" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">æœ€å¤§é“¾æ¥æ•°ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="number" class="form-input" id="action-${index}-max_links" value="${action.max_links || ''}" placeholder="ç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶">
                </div>
            `;
            break;
            
        case 'loop_click_extract':
            formHtml += `
                <div class="form-group">
                    <label class="form-label">åˆ—è¡¨é¡¹é€‰æ‹©å™¨</label>
                    <input class="form-input" id="action-${index}-list_selector" value="${escapeHtml(action.list_selector || '')}" placeholder="ul.list li æˆ– .item">
                </div>
                <div class="form-group">
                    <label class="form-label">æå–é€‰æ‹©å™¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</label>
                    <textarea class="form-textarea" id="action-${index}-extract_selectors" rows="3" placeholder="div.title&#10;div.content">${(action.extract_selectors || []).join('\n')}</textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">ç‚¹å‡»åç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰</label>
                    <input type="number" class="form-input" id="action-${index}-wait_after_click" value="${action.wait_after_click || 2}" min="0">
                </div>
            `;
            break;
            
        case 'geetest_captcha':
            formHtml += `
                <div class="form-group">
                    <label class="form-label">ç›®æ ‡ç±»å‹ï¼ˆå¯é€‰ï¼‰</label>
                    <input class="form-input" id="action-${index}-target_type" value="${escapeHtml(action.target_type || '')}" placeholder="ç•™ç©ºè¡¨ç¤ºè‡ªåŠ¨è¯†åˆ«">
                </div>
                <div class="form-group">
                    <label class="form-label">æœ€å¤§é‡è¯•æ¬¡æ•°</label>
                    <input type="number" class="form-input" id="action-${index}-max_retries" value="${action.max_retries || 3}" min="1">
                </div>
            `;
            break;
            
        case 'screenshot':
            formHtml += `
                <div class="form-group">
                    <label class="form-label">æ–‡ä»¶å</label>
                    <input class="form-input" id="action-${index}-filename" value="${escapeHtml(action.filename || '')}" placeholder="output/screenshot.png">
                </div>
            `;
            break;
            
        case 'screenshot_ocr':
            formHtml += `
                <div class="form-group">
                    <label class="form-label">æˆªå›¾æ–‡ä»¶å</label>
                    <input class="form-input" id="action-${index}-filename" value="${escapeHtml(action.filename || 'output/screenshot_ocr.png')}" placeholder="output/screenshot_ocr.png">
                </div>
                <div class="form-group">
                    <label class="form-label">æ±‡æ€»æç¤ºè¯ï¼ˆå¯é€‰ï¼‰</label>
                    <textarea class="form-textarea" id="action-${index}-summary_prompt" rows="3" placeholder="è‡ªå®šä¹‰æ±‡æ€»æç¤ºè¯ï¼Œç•™ç©ºä½¿ç”¨é»˜è®¤æç¤ºè¯">${escapeHtml(action.summary_prompt || '')}</textarea>
                    <div class="form-hint">ç•™ç©ºåˆ™ä½¿ç”¨é»˜è®¤æç¤ºè¯ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«å¹¶æ±‡æ€»å›¾ç‰‡ä¸­çš„æ–‡å­—ä¿¡æ¯</div>
                </div>
            `;
            break;
            
        case 'navigate':
            formHtml += `
                <div class="form-group">
                    <label class="form-label">ç›®æ ‡ç½‘å€</label>
                    <input class="form-input" id="action-${index}-url" value="${escapeHtml(action.url || '')}" placeholder="https://example.com">
                </div>
            `;
            break;
            
        case 'click_and_navigate':
            formHtml += `
                <div class="form-group">
                    <label class="form-label">é“¾æ¥é€‰æ‹©å™¨</label>
                    <input class="form-input" id="action-${index}-target" value="${escapeHtml(action.target || '')}" placeholder="a.link æˆ– text:é“¾æ¥æ–‡å­—">
                    <div class="form-hint">ç‚¹å‡»é“¾æ¥å¹¶å¯¼èˆªåˆ°ç›®æ ‡URLï¼Œä¸ä¾èµ–æ–°çª—å£åˆ‡æ¢</div>
                </div>
            `;
            break;
            
        case 'switch_to_new_window':
            formHtml += `
                <div class="form-group">
                    <div class="form-info">
                        <p>åˆ‡æ¢åˆ°æ–°æ‰“å¼€çš„çª—å£ã€‚é€šå¸¸åœ¨ç‚¹å‡»é“¾æ¥æ‰“å¼€æ–°çª—å£åä½¿ç”¨ã€‚</p>
                    </div>
                </div>
            `;
            break;
            
        case 'switch_to_latest_tab':
            formHtml += `
                <div class="form-group">
                    <div class="form-info">
                        <p>åˆ‡æ¢åˆ°æœ€æ–°æ‰“å¼€çš„æ ‡ç­¾é¡µã€‚</p>
                    </div>
                </div>
            `;
            break;
    }
    
    // æ‰€æœ‰åŠ¨ä½œéƒ½å¯ä»¥æ·»åŠ æ³¨é‡Š
    formHtml += `
        <div class="form-group">
            <label class="form-label">æ³¨é‡Šï¼ˆå¯é€‰ï¼‰</label>
            <input class="form-input" id="action-${index}-comment" value="${escapeHtml(action.comment || '')}" placeholder="åŠ¨ä½œè¯´æ˜">
        </div>
    `;
    
    return formHtml;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function addAction() {
    const container = document.getElementById('actions-container');
    if (!container) {
        console.error('æ‰¾ä¸åˆ° actions-container');
        return;
    }
    
    const actions = getCurrentActions();
    // æ·»åŠ æ–°çš„åŠ¨ä½œ
    actions.push({ type: 'wait', seconds: 1 });
    
    // é‡æ–°æ¸²æŸ“ï¼Œä½¿ç”¨æ–°çš„ç´¢å¼•
    container.innerHTML = renderActionsEditor(actions);
    
    // æ»šåŠ¨åˆ°åº•éƒ¨ï¼Œæ˜¾ç¤ºæ–°æ·»åŠ çš„åŠ¨ä½œ
    setTimeout(() => {
        const newItem = container.querySelector('.action-editor-item:last-child');
        if (newItem) {
            newItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }, 100);
}

function removeAction(index) {
    const container = document.getElementById('actions-container');
    if (!container) return;
    
    const actions = getCurrentActions();
    actions.splice(index, 1);
    container.innerHTML = renderActionsEditor(actions);
}

function moveAction(index, direction) {
    const container = document.getElementById('actions-container');
    if (!container) return;
    
    const actions = getCurrentActions();
    
    if (direction === 'up' && index > 0) {
        [actions[index], actions[index - 1]] = [actions[index - 1], actions[index]];
    } else if (direction === 'down' && index < actions.length - 1) {
        [actions[index], actions[index + 1]] = [actions[index + 1], actions[index]];
    } else {
        return; // æ— æ³•ç§»åŠ¨
    }
    
    container.innerHTML = renderActionsEditor(actions);
}

function changeActionType(index, newType) {
    const container = document.getElementById('actions-container');
    if (!container) return;
    
    const actions = getCurrentActions();
    
    // åˆ›å»ºæ–°ç±»å‹çš„é»˜è®¤ action
    const newAction = { type: newType };
    switch (newType) {
        case 'wait':
            newAction.seconds = 1;
            break;
        case 'checkbox':
            newAction.checked = true;
            break;
        case 'find_links_extract':
            newAction.extract_selectors = [];
            newAction.wait_after_visit = 2;
            break;
        case 'loop_click_extract':
            newAction.extract_selectors = [];
            newAction.wait_after_click = 2;
            break;
        case 'geetest_captcha':
            newAction.max_retries = 3;
            break;
    }
    
    actions[index] = newAction;
    container.innerHTML = renderActionsEditor(actions);
}

function getCurrentActions() {
    const container = document.getElementById('actions-container');
    if (!container) {
        console.warn('getCurrentActions: æ‰¾ä¸åˆ° actions-container');
        return [];
    }
    
    const items = container.querySelectorAll('.action-editor-item');
    const actions = [];
    
    // æŒ‰ç´¢å¼•æ’åºï¼Œç¡®ä¿é¡ºåºæ­£ç¡®
    const sortedItems = Array.from(items).sort((a, b) => {
        const indexA = parseInt(a.dataset.index) || 0;
        const indexB = parseInt(b.dataset.index) || 0;
        return indexA - indexB;
    });
    
    sortedItems.forEach((item) => {
        const actionIndex = parseInt(item.dataset.index) || 0;
        const typeSelect = item.querySelector('select');
        const type = typeSelect ? typeSelect.value : 'wait';
        
        const action = { type };
        
        // æ ¹æ®ç±»å‹æ”¶é›†å­—æ®µ
        switch (type) {
            case 'wait':
                const secondsEl = document.getElementById(`action-${actionIndex}-seconds`);
                if (secondsEl) action.seconds = parseFloat(secondsEl.value) || 1;
                break;
                
            case 'input':
                const inputTarget = document.getElementById(`action-${actionIndex}-target`);
                const inputValue = document.getElementById(`action-${actionIndex}-value`);
                if (inputTarget) action.target = inputTarget.value;
                if (inputValue) action.value = inputValue.value;
                break;
                
            case 'click':
            case 'hover':
            case 'extract':
            case 'click_and_navigate':
                const targetEl = document.getElementById(`action-${actionIndex}-target`);
                if (targetEl) action.target = targetEl.value;
                break;
                
            case 'select':
                const selectTarget = document.getElementById(`action-${actionIndex}-target`);
                const selectValue = document.getElementById(`action-${actionIndex}-value`);
                if (selectTarget) action.target = selectTarget.value;
                if (selectValue) action.value = selectValue.value;
                break;
                
            case 'submit':
                const submitTarget = document.getElementById(`action-${actionIndex}-target`);
                if (submitTarget && submitTarget.value) action.target = submitTarget.value;
                break;
                
            case 'extract_text':
            case 'extract_all_text':
                // æå–é¡µé¢æ–‡å­—ä¸éœ€è¦é¢å¤–å‚æ•°
                break;
                
            case 'checkbox':
                const checkboxTarget = document.getElementById(`action-${actionIndex}-target`);
                const checkboxChecked = document.getElementById(`action-${actionIndex}-checked`);
                if (checkboxTarget) action.target = checkboxTarget.value;
                if (checkboxChecked) action.checked = checkboxChecked.checked;
                break;
                
            case 'find_links_extract':
                const matchText = document.getElementById(`action-${actionIndex}-match_text`);
                const extractSelectors = document.getElementById(`action-${actionIndex}-extract_selectors`);
                const waitAfterVisit = document.getElementById(`action-${actionIndex}-wait_after_visit`);
                const maxLinks = document.getElementById(`action-${actionIndex}-max_links`);
                if (matchText) action.match_text = matchText.value;
                if (extractSelectors) {
                    action.extract_selectors = extractSelectors.value.split('\n').filter(s => s.trim());
                }
                if (waitAfterVisit) action.wait_after_visit = parseInt(waitAfterVisit.value) || 2;
                if (maxLinks && maxLinks.value) action.max_links = parseInt(maxLinks.value);
                break;
                
                
            case 'geetest_captcha':
                const targetType = document.getElementById(`action-${actionIndex}-target_type`);
                const maxRetries = document.getElementById(`action-${actionIndex}-max_retries`);
                if (targetType && targetType.value) action.target_type = targetType.value;
                if (maxRetries) action.max_retries = parseInt(maxRetries.value) || 3;
                break;
                
            case 'screenshot':
                const filename = document.getElementById(`action-${actionIndex}-filename`);
                if (filename) action.filename = filename.value;
                break;
                
            case 'screenshot_ocr':
                const ocrFilename = document.getElementById(`action-${actionIndex}-filename`);
                const summaryPrompt = document.getElementById(`action-${actionIndex}-summary_prompt`);
                if (ocrFilename) action.filename = ocrFilename.value;
                if (summaryPrompt && summaryPrompt.value) action.summary_prompt = summaryPrompt.value;
                break;
                
            case 'navigate':
                const url = document.getElementById(`action-${actionIndex}-url`);
                if (url) action.url = url.value;
                break;
                
            case 'loop_click_extract':
                const listSelector = document.getElementById(`action-${actionIndex}-list_selector`);
                const loopExtractSelectors = document.getElementById(`action-${actionIndex}-extract_selectors`);
                const waitAfterClick = document.getElementById(`action-${actionIndex}-wait_after_click`);
                if (listSelector) action.list_selector = listSelector.value;
                if (loopExtractSelectors) {
                    action.extract_selectors = loopExtractSelectors.value.split('\n').filter(s => s.trim());
                }
                if (waitAfterClick) action.wait_after_click = parseInt(waitAfterClick.value) || 2;
                break;
                
            case 'switch_to_new_window':
            case 'switch_to_latest_tab':
                // è¿™äº›åŠ¨ä½œä¸éœ€è¦é¢å¤–å‚æ•°
                break;
        }
        
        // æ”¶é›†æ³¨é‡Š
        const commentEl = document.getElementById(`action-${actionIndex}-comment`);
        if (commentEl && commentEl.value) action.comment = commentEl.value;
        
        actions.push(action);
    });
    
    return actions;
}

async function saveTask(filename) {
    const taskData = {
        name: document.getElementById('edit-task-name').value,
        description: document.getElementById('edit-task-description').value,
        url: document.getElementById('edit-task-url').value,
        output_file: document.getElementById('edit-task-output').value,
        actions: getCurrentActions()
    };
    
    try {
        const response = await fetch(`/api/tasks/${filename}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(taskData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('ä¿å­˜æˆåŠŸ', 'success');
            closeModal();
            loadTasks();
        } else {
            showToast('ä¿å­˜å¤±è´¥: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    }
}

// ==================== åˆ›å»ºä»»åŠ¡ ====================
function showCreateTaskModal() {
    const modal = document.getElementById('modal');
    const content = document.getElementById('modal-content');
    
    const newTask = {
        name: "æ–°ä»»åŠ¡",
        description: "ä»»åŠ¡æè¿°",
        url: "https://example.com",
        actions: [],
        output_file: "output/result.csv"
    };
    
    content.innerHTML = `
        <div class="modal-header">
            <h3 class="modal-title">æ–°å»ºä»»åŠ¡</h3>
            <button class="btn-close" onclick="closeModal()">Ã—</button>
        </div>
        
        <div class="task-editor">
            <div class="form-group">
                <label class="form-label">æ–‡ä»¶å</label>
                <input class="form-input" id="new-task-filename" placeholder="task_name.json" value="new_task.json">
            </div>
            
            <div class="form-group">
                <label class="form-label">ä»»åŠ¡åç§°</label>
                <input class="form-input" id="new-task-name" value="${newTask.name}" placeholder="ä»»åŠ¡åç§°">
            </div>
            
            <div class="form-group">
                <label class="form-label">ä»»åŠ¡æè¿°</label>
                <textarea class="form-textarea" id="new-task-description" rows="2" placeholder="ä»»åŠ¡æè¿°">${newTask.description}</textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">ç›®æ ‡ç½‘å€</label>
                <input class="form-input" id="new-task-url" value="${newTask.url}" placeholder="https://example.com">
            </div>
            
            <div class="form-group">
                <label class="form-label">è¾“å‡ºæ–‡ä»¶è·¯å¾„</label>
                <input class="form-input" id="new-task-output" value="${newTask.output_file}" placeholder="output/result.csv">
            </div>
            
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <label class="form-label" style="margin: 0;">åŠ¨ä½œåˆ—è¡¨</label>
                    <button class="btn btn-primary btn-sm" onclick="addAction()">
                        <span>+</span> æ·»åŠ åŠ¨ä½œ
                    </button>
                </div>
                <div id="actions-container" class="actions-editor">
                    ${renderActionsEditor(newTask.actions)}
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="createTask()">åˆ›å»º</button>
        </div>
    `;
    
    modal.classList.add('open');
}

async function createTask() {
    const filename = document.getElementById('new-task-filename').value;
    
    if (!filename) {
        showToast('è¯·è¾“å…¥æ–‡ä»¶å', 'error');
        return;
    }
    
    const taskData = {
        name: document.getElementById('new-task-name').value,
        description: document.getElementById('new-task-description').value,
        url: document.getElementById('new-task-url').value,
        output_file: document.getElementById('new-task-output').value,
        actions: getCurrentActions()
    };
    
    try {
        const response = await fetch('/api/tasks', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ...taskData, _file: filename })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('åˆ›å»ºæˆåŠŸ', 'success');
            closeModal();
            loadTasks();
        } else {
            showToast('åˆ›å»ºå¤±è´¥: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('åˆ›å»ºå¤±è´¥: ' + error.message, 'error');
    }
}

// ==================== åˆ é™¤ä»»åŠ¡ ====================
async function deleteTask(filename) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤ä»»åŠ¡ "${filename}" å—ï¼Ÿ`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/tasks/${filename}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('åˆ é™¤æˆåŠŸ', 'success');
            loadTasks();
            closeDetailPanel();
        } else {
            showToast('åˆ é™¤å¤±è´¥: ' + data.error, 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
    }
}

// ==================== å·¥å…·å‡½æ•° ====================
function formatDate(isoString) {
    if (!isoString) return 'æœªçŸ¥';
    try {
        const date = new Date(isoString);
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return isoString;
    }
}

// ==================== å…¬å¸èµ„è´¨ ====================
let companies = [];
let currentCompanyData = null;

async function loadCompanies() {
    const container = document.getElementById('companies-container');
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    try {
        const response = await fetch('/api/companies');
        const data = await response.json();
        
        if (data.success) {
            companies = data.companies;
            renderCompanies();
        }
    } catch (error) {
        showToast('åŠ è½½å¤±è´¥', 'error');
    }
}

function renderCompanies() {
    const container = document.getElementById('companies-container');
    
    if (companies.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ¢</div>
                <div class="empty-title">æš‚æ— å…¬å¸èµ„è´¨æ•°æ®</div>
                <div class="empty-text">è¿è¡Œä»»åŠ¡åï¼Œå…¬å¸èµ„è´¨ä¿¡æ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
            </div>
        `;
        return;
    }
    
    // è½¬ä¹‰å…¬å¸åç§°ï¼Œé¿å…XSSå’Œç‰¹æ®Šå­—ç¬¦é—®é¢˜
    const escapeHtml = (text) => {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    };
    
    // åˆ›å»ºtabé¡µç»“æ„
    container.innerHTML = `
        <div class="companies-tabs">
            <div class="tab-buttons">
                ${companies.map((company, index) => `
                    <button class="tab-button ${index === 0 ? 'active' : ''}" 
                            onclick="switchCompanyTab('${escapeHtml(company.name)}', ${index})"
                            data-company-name="${escapeHtml(company.name)}">
                        ${escapeHtml(company.name)}
                        <span class="tab-badge">${company.certificate_count || 0}</span>
                    </button>
                `).join('')}
            </div>
            <div class="tab-content">
                ${companies.map((company, index) => `
                    <div class="tab-panel ${index === 0 ? 'active' : ''}" id="tab-${escapeHtml(company.name)}">
                        <div class="loading"><div class="spinner"></div></div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
    
    // åŠ è½½ç¬¬ä¸€ä¸ªå…¬å¸çš„æ•°æ®
    if (companies.length > 0) {
        loadCompanyData(companies[0].name, 0);
    }
}

function switchCompanyTab(companyName, index) {
    // æ›´æ–°tabæŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.tab-button').forEach((btn, idx) => {
        btn.classList.toggle('active', idx === index);
    });
    
    // æ›´æ–°tabé¢æ¿çŠ¶æ€
    document.querySelectorAll('.tab-panel').forEach((panel, idx) => {
        panel.classList.toggle('active', idx === index);
    });
    
    // åŠ è½½å…¬å¸æ•°æ®ï¼ˆä½¿ç”¨dataå±æ€§è·å–å…¬å¸åç§°ï¼Œæ›´å®‰å…¨ï¼‰
    const button = document.querySelectorAll('.tab-button')[index];
    const actualCompanyName = button ? button.getAttribute('data-company-name') || companyName : companyName;
    loadCompanyData(actualCompanyName, index);
}

async function loadCompanyData(companyName, index) {
    const panel = document.getElementById(`tab-${companyName}`);
    if (!panel) {
        console.error(`æ‰¾ä¸åˆ°é¢æ¿: tab-${companyName}`);
        return;
    }
    
    panel.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    try {
        const encodedName = encodeURIComponent(companyName);
        const url = `/api/companies/${encodedName}`;
        console.log(`åŠ è½½å…¬å¸æ•°æ®: ${url}`);
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            currentCompanyData = data;
            renderCompanyCertificates(data, panel);
        } else {
            throw new Error(data.error || 'åŠ è½½å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½å…¬å¸æ•°æ®å¤±è´¥:', error);
        panel.innerHTML = `
            <div class="empty-state">
                <div class="empty-title">åŠ è½½å¤±è´¥</div>
                <div class="empty-text">${error.message}</div>
            </div>
        `;
        showToast(`åŠ è½½å…¬å¸æ•°æ®å¤±è´¥: ${error.message}`, 'error');
    }
}

function renderCompanyCertificates(companyData, container) {
    const certificates = companyData.certificates || [];
    const lastUpdated = companyData.last_updated;
    
    if (certificates.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">ğŸ“‹</div>
                <div class="empty-title">æš‚æ— èµ„è´¨ä¿¡æ¯</div>
                <div class="empty-text">è¯¥å…¬å¸çš„èµ„è´¨ä¿¡æ¯å°†åœ¨æŸ¥è¯¢åæ˜¾ç¤º</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = `
        <div class="company-header">
            <div class="company-info">
                <h2>${companyData.company_name}</h2>
                <div class="company-meta">
                    <span>æœ€åæ›´æ–°: ${lastUpdated ? formatDate(lastUpdated) : 'æœªçŸ¥'}</span>
                    <span>èµ„è´¨ç±»å‹: ${certificates.length} ç§</span>
                </div>
            </div>
        </div>
        
        <div class="certificates-list">
            ${certificates.map((cert, index) => renderCertificateCard(cert, index, companyData.company_name)).join('')}
        </div>
    `;
}

function renderCertificateCard(certInfo, index, companyName) {
    const taskName = certInfo.task_name;
    const certificates = certInfo.certificates || [];
    const lastQueryTime = certInfo.last_query_time;
    // ä½¿ç”¨å…¬å¸åç§°å’Œç´¢å¼•ç”Ÿæˆå”¯ä¸€IDï¼Œé¿å…ä¸åŒtabä¹‹é—´çš„IDå†²çª
    const safeCompanyName = (companyName || '').replace(/[^a-zA-Z0-9]/g, '_');
    const safeTaskName = (taskName || '').replace(/[^a-zA-Z0-9]/g, '_');
    const cardId = `cert-card-${safeCompanyName}-${safeTaskName}-${index}`;
    const detailsId = `cert-details-${safeCompanyName}-${safeTaskName}-${index}`;
    
    return `
        <div class="certificate-card">
            <div class="certificate-header clickable" onclick="toggleCertificateCard('${detailsId}')">
                <div class="certificate-header-left">
                    <span class="certificate-toggle-icon" id="icon-${detailsId}">â–¼</span>
                    <h3>${taskName}</h3>
                </div>
                <span class="certificate-count">${certInfo.total_count || 0} ä¸ªè¯ä¹¦</span>
            </div>
            
            <div class="certificate-meta">
                <span>æœ€åæŸ¥è¯¢: ${lastQueryTime ? formatDate(lastQueryTime) : 'æœªçŸ¥'}</span>
            </div>
            
            <div class="certificate-details-container" id="${detailsId}" style="display: none;">
                ${certificates.length > 0 ? `
                    <div class="certificate-details">
                        ${certificates.map(cert => `
                            <div class="cert-detail-item ${cert.is_valid === false ? 'expired' : ''}">
                                <div class="cert-detail-row">
                                    <span class="cert-label">èµ„è´¨åç§°:</span>
                                    <span class="cert-value">${cert['èµ„è´¨åç§°'] || cert['è¯ä¹¦åç§°'] || 'N/A'}</span>
                                </div>
                                ${cert['èµ„è´¨ç­‰çº§'] ? `
                                    <div class="cert-detail-row">
                                        <span class="cert-label">èµ„è´¨ç­‰çº§:</span>
                                        <span class="cert-value cert-level">${cert['èµ„è´¨ç­‰çº§']}</span>
                                    </div>
                                ` : ''}
                                ${cert['æœ‰æ•ˆæœŸè‡³'] ? `
                                    <div class="cert-detail-row">
                                        <span class="cert-label">æœ‰æ•ˆæœŸè‡³:</span>
                                        <span class="cert-value ${cert.is_valid === false ? 'expired-text' : ''}">${cert['æœ‰æ•ˆæœŸè‡³']}</span>
                                        ${cert.is_valid === false ? '<span class="expired-badge">å·²è¿‡æœŸ</span>' : '<span class="valid-badge">æœ‰æ•ˆ</span>'}
                                    </div>
                                ` : ''}
                                ${cert['è¯ä¹¦ç¼–å·'] ? `
                                    <div class="cert-detail-row">
                                        <span class="cert-label">è¯ä¹¦ç¼–å·:</span>
                                        <span class="cert-value">${cert['è¯ä¹¦ç¼–å·']}</span>
                                    </div>
                                ` : ''}
                                ${cert['å‘è¯æœºæ„'] ? `
                                    <div class="cert-detail-row">
                                        <span class="cert-label">å‘è¯æœºæ„:</span>
                                        <span class="cert-value">${cert['å‘è¯æœºæ„']}</span>
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : `
                    <div class="no-certificates">
                        <p>${certInfo.summary || 'æœªæ‰¾åˆ°æœ‰æ•ˆè¯ä¹¦'}</p>
                    </div>
                `}
            </div>
        </div>
    `;
}

// ==================== èµ„è´¨å¯¹æ¯” ====================
async function loadCompareView() {
    // åŠ è½½æœ‰èµ„è´¨æ•°æ®çš„å…¬å¸åˆ—è¡¨åˆ°é€‰æ‹©å™¨
    try {
        const response = await fetch('/api/companies');
        const data = await response.json();
        
        if (data.success) {
            const targetSelect = document.getElementById('compare-target-company');
            const refSelect = document.getElementById('compare-ref-company');
            
            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……
            targetSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å…¬å¸</option>';
            refSelect.innerHTML = '';
            
            data.companies.forEach(company => {
                targetSelect.innerHTML += `<option value="${company.name}">${company.name}</option>`;
                refSelect.innerHTML += `<option value="${company.name}" ${company.name === 'ä¸­ç§»ç³»ç»Ÿé›†æˆæœ‰é™å…¬å¸' ? 'selected' : ''}>${company.name}</option>`;
            });
        }
    } catch (error) {
        showToast('åŠ è½½å…¬å¸åˆ—è¡¨å¤±è´¥', 'error');
    }
}

async function runComparison() {
    const targetCompany = document.getElementById('compare-target-company').value;
    const refCompany = document.getElementById('compare-ref-company').value;
    
    if (!targetCompany) {
        showToast('è¯·é€‰æ‹©å·±æ–¹å…¬å¸', 'error');
        return;
    }
    
    if (targetCompany === refCompany) {
        showToast('ä¸èƒ½ä¸è‡ªå·±å¯¹æ¯”', 'error');
        return;
    }
    
    const resultContainer = document.getElementById('compare-result');
    resultContainer.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    try {
        const response = await fetch('/api/compare', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                target_company: targetCompany,
                reference_company: refCompany
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            renderComparisonResult(data);
        } else {
            showToast(data.error || 'å¯¹æ¯”å¤±è´¥', 'error');
            resultContainer.innerHTML = `<div class="empty-state"><div class="empty-title">å¯¹æ¯”å¤±è´¥</div><div class="empty-text">${data.error}</div></div>`;
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
        resultContainer.innerHTML = '<div class="empty-state"><div class="empty-title">ç½‘ç»œé”™è¯¯</div></div>';
    }
}

function renderComparisonResult(data) {
    const container = document.getElementById('compare-result');
    const { target_company, reference_company, comparison, summary } = data;
    
    container.innerHTML = `
        <div class="compare-summary">
            <h3>ğŸ“Š å¯¹æ¯”æ‘˜è¦</h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-value">${summary.total}</span>
                    <span class="summary-label">èµ„è´¨æ€»æ•°</span>
                </div>
                <div class="summary-item target">
                    <span class="summary-value">${summary.target_has}</span>
                    <span class="summary-label">å·±æ–¹æŒæœ‰</span>
                </div>
                <div class="summary-item ref">
                    <span class="summary-value">${summary.ref_has}</span>
                    <span class="summary-label">å¯¹æ–¹æŒæœ‰</span>
                </div>
                <div class="summary-item">
                    <span class="summary-value">${summary.both_have}</span>
                    <span class="summary-label">åŒæ–¹å…±æœ‰</span>
                </div>
                <div class="summary-item success">
                    <span class="summary-value">${summary.target_only}</span>
                    <span class="summary-label">å·±æ–¹ç‹¬æœ‰</span>
                </div>
                <div class="summary-item danger">
                    <span class="summary-value">${summary.ref_only}</span>
                    <span class="summary-label">å·±æ–¹ç¼ºå¤±</span>
                </div>
            </div>
            <div class="compare-actions">
                <button class="btn btn-success" onclick="exportComparison('${target_company}', '${reference_company}')">
                    ğŸ“¥ å¯¼å‡ºExcelæŠ¥å‘Š
                </button>
            </div>
        </div>
        
        <div class="compare-table-container">
            <table class="compare-table">
                <thead>
                    <tr>
                        <th>èµ„è´¨åç§°</th>
                        <th>å·±æ–¹è¯ä¹¦ç¼–å·</th>
                        <th>å·±æ–¹æ˜¯å¦å…·æœ‰</th>
                        <th>å¯¹æ–¹è¯ä¹¦ç¼–å·</th>
                        <th>å¯¹æ–¹æ˜¯å¦å…·æœ‰</th>
                        <th>å¯¹æ¯”æ¦‚è¿°</th>
                    </tr>
                </thead>
                <tbody>
                    ${comparison.map(item => `
                        <tr class="${getRowClass(item)}">
                            <td class="qual-name">${item.qualification_name}</td>
                            <td>${item.target_cert_no}</td>
                            <td class="${item.target_has ? 'has-yes' : 'has-no'}">${item.target_has ? 'æ˜¯' : 'å¦'}</td>
                            <td>${item.ref_cert_no}</td>
                            <td class="${item.ref_has ? 'has-yes' : 'has-no'}">${item.ref_has ? 'æ˜¯' : 'å¦'}</td>
                            <td class="overview">${item.overview}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
    `;
}

function getRowClass(item) {
    if (item.overview.includes('å·±æ–¹ç‹¬æœ‰') || item.overview.includes('å·±æ–¹é¢†å…ˆ')) {
        return 'row-success';
    } else if (item.overview.includes('å·±æ–¹ç¼ºå¤±') || item.overview.includes('å¯¹æ–¹é¢†å…ˆ')) {
        return 'row-danger';
    } else if (item.overview.includes('åŒæ–¹å‡æ— ')) {
        return 'row-warning';
    }
    return '';
}

async function exportComparison(targetCompany, refCompany) {
    showToast('æ­£åœ¨ç”ŸæˆæŠ¥å‘Š...', 'info');
    
    try {
        const response = await fetch('/api/compare/export', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                target_company: targetCompany,
                reference_company: refCompany
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼Œæ­£åœ¨ä¸‹è½½...', 'success');
            // è§¦å‘ä¸‹è½½
            const link = document.createElement('a');
            link.href = data.download_url;
            link.download = data.report_name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } else {
            showToast(data.error || 'å¯¼å‡ºå¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯: ' + error.message, 'error');
    }
}

// ==================== é…ç½® ====================
async function loadConfig() {
    const container = document.getElementById('config-container');
    container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
    
    try {
        const [configResp, companiesResp] = await Promise.all([
            fetch('/api/config'),
            fetch('/api/company-names')
        ]);
        
        const configData = await configResp.json();
        const companiesData = await companiesResp.json();
        
        let html = '';
        
        // å…¬å¸åç§°ç®¡ç†
        const companyNames = companiesData.success ? companiesData.companies : [];
        html += `
            <div class="config-section">
                <h3>ğŸ¢ å…¬å¸åç§°ç®¡ç†</h3>
                <div class="company-names-list" id="company-names-list">
                    ${companyNames.map(name => `
                        <div class="company-name-item">
                            <span>${name}</span>
                            <button class="btn btn-danger btn-sm" onclick="deleteCompanyName('${name}')">åˆ é™¤</button>
                        </div>
                    `).join('')}
                </div>
                <div class="add-company-form">
                    <input type="text" class="form-input" id="new-company-name" placeholder="è¾“å…¥æ–°å…¬å¸åç§°">
                    <button class="btn btn-primary" onclick="addCompanyName()">æ·»åŠ å…¬å¸</button>
                </div>
            </div>
        `;
        
        if (configData.success) {
            html += `
                <div class="config-section">
                    <h3>ğŸŒ æµè§ˆå™¨é…ç½®</h3>
                    ${Object.entries(configData.browser).map(([key, value]) => `
                        <div class="config-item">
                            <span class="config-key">${key}</span>
                            <span class="config-value">${JSON.stringify(value)}</span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="config-section">
                    <h3>ğŸ¤– å¤§æ¨¡å‹é…ç½®</h3>
                    ${Object.entries(configData.llm).map(([key, value]) => `
                        <div class="config-item">
                            <span class="config-key">${key}</span>
                            <span class="config-value">${JSON.stringify(value)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        container.innerHTML = html;
    } catch (error) {
        container.innerHTML = '<div class="empty-state"><div class="empty-title">åŠ è½½é…ç½®å¤±è´¥</div></div>';
    }
}

async function addCompanyName() {
    const input = document.getElementById('new-company-name');
    const name = input.value.trim();
    
    if (!name) {
        showToast('è¯·è¾“å…¥å…¬å¸åç§°', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/company-names', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('æ·»åŠ æˆåŠŸ', 'success');
            input.value = '';
            loadConfig();
        } else {
            showToast(data.error || 'æ·»åŠ å¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯', 'error');
    }
}

async function deleteCompanyName(name) {
    if (!confirm(`ç¡®å®šåˆ é™¤å…¬å¸ "${name}" å—ï¼Ÿ`)) return;
    
    try {
        const response = await fetch(`/api/company-names/${encodeURIComponent(name)}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('åˆ é™¤æˆåŠŸ', 'success');
            loadConfig();
        } else {
            showToast(data.error || 'åˆ é™¤å¤±è´¥', 'error');
        }
    } catch (error) {
        showToast('ç½‘ç»œé”™è¯¯', 'error');
    }
}

// ==================== æ¨¡æ€æ¡† ====================
function closeModal() {
    document.getElementById('modal').classList.remove('open');
}

// ==================== Toast é€šçŸ¥ ====================
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <span>${type === 'success' ? 'âœ“' : type === 'error' ? 'âœ—' : 'â„¹'}</span>
        <span>${message}</span>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// ==================== å¿«æ·é”® ====================
document.addEventListener('keydown', (e) => {
    // ESC å…³é—­æ¨¡æ€æ¡†å’Œé¢æ¿
    if (e.key === 'Escape') {
        closeModal();
        closeDetailPanel();
    }
});

